import os
import sys
from lxml import etree
from xml.etree import ElementTree

HTML_HEAD = """
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Report</title>
  </head>
  <body height="100%">
    <h1>Report</h1>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      
"""
HTML_MIDDLE = """
    <div class="tab-content" id="myTabContent"  style='height:"100%'>
"""
HTML_FOOT = """
    </div>
  </body>
</html>
"""


def iframe(url):
    return "<iframe src='"+url+"' width='100%' height='50%'></iframe>"


def generate_report(dir):
    out = HTML_HEAD
    bookmarks = ""
    contents = ""
    directories = [a for a in os.listdir(dir) if os.path.isdir(dir+"/"+a)]
    for i, ip_addr in enumerate(directories):
        bookmarks = bookmarks + """
            <li class="nav-item">
        """
        link = """<a class="nav-link" id="contact-tab" """ + \
            """ data-toggle="tab" href="#tab""" + \
            str(i) + """" role="tab" aria-controls="contact" """ +\
            """aria-selected="false">""" + \
            ip_addr+"""</a>"""
        bookmarks = bookmarks + link
        bookmarks = bookmarks + "</li>"
        cc = ""
        cc += "<h1>"+ip_addr+"</h1>"
        cc += """<ul class="nav nav-tabs" id="myTab" role="tablist">"""
        cc += "</ul>"
        if os.path.isdir(dir+"/"+ip_addr+"/IG"):

            cc += "<h2>Information gathering (IG)</h2>"

            if(os.path.isfile(dir+"/"+ip_addr+"/IG/metasploit_scan.txt")):
                cc += "<h3>Metasploit result:</h3>"
                cc += iframe(ip_addr+"/IG/metasploit_scan.txt")
            cc += "<h3>NMAP:</h3>"
            cc += "<h4>TCP/IP Scan:</h4>"
            if(os.path.isfile(dir+"/"+ip_addr+"/IG/NMAP/script-syn.html")):
                cc += iframe(ip_addr+"/IG/NMAP/script-syn.html")
                tre = etree.parse(dir+"/"+ip_addr+"/IG/NMAP/script-syn.xml")
                vulns = tre.xpath('//script[@id="vulners"]')
                vuln_ids = []
                if len(vulns) > 0:
                    vuln_ids = [row.text for row in vulns[0].xpath(
                        'table/table/elem[@key="id"]')]
                    cc += "<p>Found vulnerabilities:</p>"
                    for vi in vuln_ids:
                        cc += "<p>"+vi+"</p>"
                else:
                    cc += "No vulnerabilities"
            cc += "<h4>UDP Scan:</h4>"
            if(os.path.isfile(dir+"/"+ip_addr+"/IG/NMAP/udp.html")):
                cc += iframe(ip_addr+"/IG/NMAP/udp.html")
                tre = etree.parse(dir+"/"+ip_addr+"/IG/NMAP/udp.xml")
                vulns = tre.xpath('//script[@id="vulners"]')
                vuln_ids = []
                if len(vulns) > 0:
                    vuln_ids = [row.text for row in vulns[0].xpath(
                        'table/table/elem[@key="id"]')]
                    cc += "<p>Found vulnerabilities:</p>"
                    for vi in vuln_ids:
                        cc += "<p>"+vi+"</p>"
                else:
                    cc += "No vulnerabilities"
        if os.path.isdir(dir+"/"+ip_addr+"/DA"):
            cc += "<h2>Dictionary Attack (DA)</h2>"
            cc += "<h3>EVIDENCE</h3>"
            for a in os.listdir(dir+"/"+ip_addr+"/DA/EVIDENCE/"):
                cc += iframe(ip_addr+"/DA/EVIDENCE/"+a)
            cc += "<h3>PASSWORD</h3>"
            for a in os.listdir(dir+"/"+ip_addr+"/DA/PASSWORD/"):
                cc += iframe(ip_addr+"/DA/PASSWORD/"+a)
        if os.path.isdir(dir+"/"+ip_addr+"/VA"):
            cc += "<h2>Vulnerability assesment(VA)</h2>"
            if os.path.isdir(dir+"/"+ip_addr+"/VA/KNOWN_EXPLOITS"):
                if os.path.isfile(
                    dir+"/"+ip_addr+"/VA/KNOWN_EXPLOITS/exploit-db.txt"
                ):
                    cc += "exploitdb"
                    cc += iframe(ip_addr+"/VA/KNOWN_EXPLOITS/exploit-db.txt")
                if os.path.isfile(
                    dir+"/"+ip_addr+"/VA/KNOWN_EXPLOITS/meta_module.txt"
                ):
                    cc += "metasploit"
                    cc += iframe(ip_addr+"/VA/KNOWN_EXPLOITS/meta_module.txt")
            for item in os.listdir(dir+"/"+ip_addr+"/VA/"):
                if os.path.isfile(dir+"/"+ip_addr+"/VA/"+item):
                    cc += item
                    cc += iframe(ip_addr+"/VA/"+item)
            cc += "Found CVE"
            if(os.path.isfile(dir+"/"+ip_addr+"/IG/NMAP/CVE.txt")):
                cc += iframe(ip_addr+"/IG/NMAP/CVE.txt")
        contents += """<div class="tab-pane fade show" id="tab""" + \
            str(i)+"""" role="tabpanel" """ +\
            """aria-labelledby="home-tab" height="100%">"""
        contents += cc + "</div>"
    out = out + bookmarks + \
        """</ul><div class="tab-content" id="myTabContent" """ +\
        """ style='height:"100%'>"""+contents

    out = out + "</div>"+HTML_FOOT
    with open(dir+"/index.html", "w") as f:
        f.write(out)


if __name__ == "__main__":
    if os.path.isdir(sys.argv[1]):
        print(generate_report(sys.argv[1]))
    else:
        print(sys.argv[1]+" is not directory")
